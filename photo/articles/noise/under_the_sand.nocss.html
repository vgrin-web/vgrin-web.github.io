<html>
<head>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<title>Под песком</title>
<meta name="keywords" content="ADC Noise, Dynamic Range, шум АЦП, динамический диапазон">
</head>
<body text="#000000" bgcolor="#F0F0F0" link="#8080ff" vlink = "C080C0">
<center>
  <h2><font face="Arial, Helvetica, sans-serif">Под песком</font></h2>
  <font face="Arial, Helvetica, sans-serif">о шуме, динамическом диапазоне и фотографических экспериментах не имеющих отношения к фотографии</font><br>
</center>
<p>
<hr width="50%" color="#FFFFFF">
<p> 
Согласно [1], [2], [3] уровень шума N-разрядного АЦП составляет 
<br><b>SNR = 6.02N + 1.76 dB</b>. (1)<br>
Причем в работе [2] прямо указывается, что:
<br><i>For an N-bit ADC, the dynamic range (DR) can be calculated as:
<br><b>DR = 6.021N + 1.763 dB</b></i> 
<br>то есть динамический диапазон АЦП выше, чем отношения максимально возможной измеряемой величины сигнала к величине, соотвествующей младшему значащему разряду или 2<sup>N</sup> стопов. При этом предполагается, что уровень шума самого сигнала ниже младшего значащего разряда.
<br>В работе [3] дается вывод этой формулы.
<br><p>
<center><h3>Эксперимeнт 1</h3></center>
Мы будем эмулировть 8-битный АПЦ путем обнуления младших разрядов значений записаных в RAW. Расчетное значения для динамического диапазона согласно формуле (1) составляет 8.29 стопа. Ниже приведены две фотографии, малоразмерного объекта - оранжевого светодиода диаметром 1.5 мм находящегося в темной комнате сфотографированного с расстояния примерно 1.5 м при помощи 70 мм объектива.
Фотографии содержат данные красного канала RAW в которых младшие 4 бита из 12 обнулены, сняты со следующими параметрами экспозиции: 
<br><b>_DSC0705.NEF - 1/15 sec, f/22.0
<br>_DSC0722.NEF - 1/1.3 sec, f/4.5</b>
<br>при помощи фотоаппарата Nikon D70, ISO 200. Нетрудно рассчитать, что экспозиция отличается на 8.1 стопа.
<br><br><img src="8_1.jpg" width=625 height=316 border=0 alt="8.1 eV"><br><br>
Левый кадр усилен в 128 раз, что бы было хорошо видно; и так имеем сигнал на левом кадре и нет пересвета на правом. 
Таким образом при помощие 8-битного фотоаппарата загегистрирован динамический диапазон в 8.1 стопа.
<br>
<b>Обсуждение:</b>
<br>критика состоит в том, что файл был разложен на поканальны файлы при помощи программы <a href="../dcraw_parser.rar">dcraw_parser</a> написанной на базе dcraw, код которого труден в понимании и проверке на наличие ошибок. Поэтому последующие эксперименты будут проводится при помощи камеры Fuji S5Pro. Она имеет очень простой формат RAW файла - это массив 16-битных двухбайтных слов в которых младшие 14 бит содержат данные полученные с АЦП, старшие 2 бита обнулены. По смещению 100 от начала файла хранится 4-байтная величина смещения начала массива от начала файла. Формат байт - Little-endian (IBM). Таким образом программа для анализа файлов может быть легко написана любым исследователем владеющим каким-либо языком програмирования. В нашем случае использовалась программа <a href="../RafS3ProSplitter.rar">RafS3ProSplitter</a>
<br>
Кроме того для осллабления сигнала использовался нейтральный B+W 110 ND 3.0 фильтр с коеффициентом поглощения равным 10 стопам. Перед использованием фильтр был <a href="bw110_nd3_10x_filter.html">калиброван</a> и было установлено, что его коеффициенты пропускания равны:
<i><br>красный 10.3 стопа
<br>зеленый 10.6 стопа
<br>синий 10.9 стопа</i>
<br><p>
<center><h3>Эксперимeнт 2</h3></center>
<br>Как указано в работе [1]:
<br><i>"Для того чтобы выиграть дополнительное «разрешение» для большего числа значащих битов, необходимо выполнять усреднение с арифметической точностью."</i><br>
На серии фотографий изображен красный канал снимков того же светодиода, первый кадр сделан без фильтра, остальные с 10х фильтром, эти изображения усилены в 1024 раза.. Экспозиционные параметры одинаквые: 1/25 sec, F/4, ISO 160. 
<br><br><img src="0_minus10_noise_u9_sum_u6.png" width=1230 height=898 border=0 alt="16 frames"><br><br>
Последний кадр - это результат арифметического сложения кадров сделанных с фильтром, полученный при помощи специально написанной программы сумматора. В результате этого сложения сигнал становится наблюдаемым на фоне шума.
<br>Сложение меньшего числа файлов дает следующий результат:
<br><br><img src="sum_u6_fr_2_4_8_16.png" width=673 height=703 border=0 alt="2, 4, 8 16 frames">
<br><br>
<b>Обсуждение:</b>
<br>выделение сигнала на фоне шума требует сложения большого числа кадров. Для более слабых сигналов потребуется слишком много кадров и такой эксперимент становится слишком трудоёмким. В качестве альтернативы можно суммировать не пиксели нескольких кадров, а пиксели одного кадра. Таким образом мы можем увеличить динамический диапазом ценой разрешения. Это не позволит детектировать малоразмерные объекты, но для объектов размером близким к размеру кадра эффект должен наблюдатся.
<br><p>
<center><h3>Эксперимeнт 3</h3></center>
<br>Сделана серия кадров, первый без фильтра, последующие с филтром 10х и разными экспопараметрами:
<i><br>ISO 125
<table cellspacing="0" cellpadding="1">
<tr><td>_DSF4892.RAF</td><td>25/10</td><td>F/4</td><td>без фильтра</td></tr>
<tr><td>_DSF4895.RAF</td><td>25/10</td><td>F/4</td></tr>
<tr><td>_DSF4896.RAF</td><td>13/10</td><td>F/4</td></tr>
<tr><td>_DSF4897.RAF</td><td>10/16</td><td>F/4</td></tr>
<tr><td>_DSF4898.RAF</td><td>10/30</td><td>F/4</td></tr>
<tr><td>_DSF4899.RAF</td><td>10/50</td><td>F/4</td></tr>
<tr><td>_DSF4900.RAF</td><td>10/60</td><td>F/4</td></tr>
<tr><td>_DSF4901.RAF</td><td>10/80</td><td>F/4</td></tr>
<tr><td>_DSF4902.RAF</td><td>10/100</td><td>F/4</td></tr>
<tr><td>_DSF4903.RAF</td><td>10/130</td><td>F/4</td></tr>
</table></i>
<br>Кадры были уменьшены в 10 раз по стороне при помощи специальной програмы вычисляющей значение пикселя по сумме 100 (10х10) пикселей исходного изображения. Полученные кадры усилены для лучшей визуализации
<br><br>
<img src="0_minus15.png" width=1226 height=489 border=0 alt="S5Pro 0 eV - -15 eV">
<br><br>
Аналогичный эксперимент был проведен с Nikon D70 имеющей 12-битный АЦП
<br><br>
<img src="d70_0_minus13.png" alt="Nikon D70 0 eV - -13 eV">
<br><br>
Обработка и уменьшение также возможно и в графическом редакторе (Фотошоп и ACR), но дает меньше контроля за результатами:
<br>
<font size="-2">Внимание: уровень черного в ACR должен быть установлен в 0 обязательно!</font>
<br><br>
<img src="d70_0_minus13_acr.png" alt="Nikon D70 0 eV - -13 eV ACR">
<br><br>
<b>Обсуждение:</b>
<br>
Показано, что разрядность АЦП не является пределом для достижимого динамического диапазона и что путем увеличения времени измерения или потерей разрешения динамический диапазон может быть расширен, как и указывается в цитируемой литературе.
<br><br>
<b>Литература:</b>
<dl>
	<dt>1.<a href="http://www.analog.com/library/analogDialogue/archives/40-02/adc_noise.html">ADC Input Noise: The Good, The Bad, and The Ugly. Is No Noise Good Noise?</a> <a href="adc_noise.pdf">PDF</a>, перевод <a href="http://www.kit-e.ru/articles/dac/2008_09_42.php">Входной шум АЦП: хороший, плохой и опасный. Хорошо ли, когда его нет?</a> <a href="2008_09_42.pdf">PDF</a><dd>
	<dt>2.<a href="http://www.analog.com/library/analogDialogue/archives/45-12/dynamic_range.html">Oversampled ADC and PGA Combine to Provide 127-dB Dynamic Range</a> <a href="dynamic_range.pdf">PDF</a><dd>
	<dt>3.<a href="http://ets.ifmo.ru/denisov/dsp/lec3.htm">Лекция №3 "Аналого-цифровое и цифро-аналоговое преобразование"</a>	<a href="digital_technic.pdf">PDF</a><dd>
</dl>
<br>
<p>
<hr width="50%" color="#FFFFFF">
<p>
<!---Copyright--->
<BR>
<P ALIGN="Center"><FONT SIZE="-2">All contents
copyright &copy; <A HREF="https://forum.ixbt.com/users.cgi?id=email:vgrin"><b>vgrin</b></A>, first published April 28, 2012. Ver 3.01, January 20, 2015</FONT></P>
<!---Copyright--->
</body>
</html>